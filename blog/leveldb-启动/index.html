<!DOCTYPE html>
<html lang="en"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LevelDB Startup</title>
    <meta charset="utf-8">
    <meta name="description" content="Ladder@This is the first chapter of my notes on reading the LevelDB source code, focusing on the startup process of LevelDB. This article is not a step-by-step source code tutorial, but rather a learning note that records my questions and thoughts.
A code repository with annotations will be shared on GitHub later for those interested in studying it.
Prerequisites Database Files For now, I won&rsquo;t delve into the encoding and naming details of these files (as I haven&rsquo;t reached that part yet).">
    <meta name="author" content="NoneBack">
    <link rel="canonical" href="https://noneback.github.io/blog/leveldb-%E5%90%AF%E5%8A%A8/">
        <meta name="google-site-verification" content="xxx">

    <link rel="alternate" type="application/rss+xml" href="https://noneback.github.io//index.xml" title="NoneBack">

    
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-H0SRTJWPEK"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-H0SRTJWPEK');
        }
      </script>
    
  




<script async defer data-website-id="43dc9e5a-7ab8-482e-94df-100975b5d2c8" src="https://umami-blog-pi.vercel.app/noneback-blog"></script>

    <meta property="og:url" content="https://noneback.github.io/blog/leveldb-%E5%90%AF%E5%8A%A8/">
  <meta property="og:site_name" content="NoneBack">
  <meta property="og:title" content="LevelDB Startup">
  <meta property="og:description" content="This is the first chapter of my notes on reading the LevelDB source code, focusing on the startup process of LevelDB. This article is not a step-by-step source code tutorial, but rather a learning note that records my questions and thoughts.
A code repository with annotations will be shared on GitHub later for those interested in studying it.
Prerequisites Database Files For now, I won’t delve into the encoding and naming details of these files (as I haven’t reached that part yet).">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2022-04-09T14:43:25+08:00">
    <meta property="article:modified_time" content="2022-04-09T14:43:25+08:00">
    <meta property="article:tag" content="LSM">
    <meta property="article:tag" content="LevelDB">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="LevelDB Startup">
  <meta name="twitter:description" content="This is the first chapter of my notes on reading the LevelDB source code, focusing on the startup process of LevelDB. This article is not a step-by-step source code tutorial, but rather a learning note that records my questions and thoughts.
A code repository with annotations will be shared on GitHub later for those interested in studying it.
Prerequisites Database Files For now, I won’t delve into the encoding and naming details of these files (as I haven’t reached that part yet).">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://noneback.github.io/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "LevelDB Startup",
      "item": "https://noneback.github.io/blog/leveldb-%E5%90%AF%E5%8A%A8/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "LevelDB Startup",
  "name": "LevelDB Startup",
  "description": "This is the first chapter of my notes on reading the LevelDB source code, focusing on the startup process of LevelDB. This article is not a step-by-step source code tutorial, but rather a learning note that records my questions and thoughts.\nA code repository with annotations will be shared on GitHub later for those interested in studying it.\nPrerequisites Database Files For now, I won\u0026rsquo;t delve into the encoding and naming details of these files (as I haven\u0026rsquo;t reached that part yet).",
  "keywords": [
    "LevelDB", "LSM", "KV"
  ],
  "articleBody": "This is the first chapter of my notes on reading the LevelDB source code, focusing on the startup process of LevelDB. This article is not a step-by-step source code tutorial, but rather a learning note that records my questions and thoughts.\nA code repository with annotations will be shared on GitHub later for those interested in studying it.\nPrerequisites Database Files For now, I won’t delve into the encoding and naming details of these files (as I haven’t reached that part yet). I’ll focus on the meaning and role of each file.\n├── 000005.ldb ├── 000008.ldb // sst or ldb are both sst files ├── 000009.log // WAL ├── CURRENT // Records the name of the manifest file in use, also indicates the presence of the database ├── LOCK // Empty file, ensures only one DB instance operates on the database ├── LOG // Logs printed by LevelDB ├── LOG.old └── MANIFEST-000007 // descriptor_file, metadata file Some questions worth exploring, which I may write about later:\nHow does LOCK ensure only one DB instance holds the database? Essentially, it uses the fcntl system call to set a write lock on the LOCK file.\nEncoding issues of various files I’ll discuss LevelDB’s encoding design in a future blog.\nDB State LevelDB is an embedded database, often used as a component in other applications (e.g., for metadata nodes in distributed storage systems). These applications may crash or exit gracefully, leaving LevelDB data files behind. Thus, it’s necessary to restore the previous database state during startup to ensure data integrity.\nSo, what should the DB state include? LevelDB is an LSM-based storage engine, essentially an LSM Tree data structure + various read/write and storage optimizations. Based on this and LevelDB’s documentation, the DB state includes at least the following persistent information:\nThe SST files for each level and the key range covered by each SST file The key range helps avoid unnecessary I/O.\nGlobal logical clock, last_seq_number Each data update has a seq_num that marks the recency of the update and is related to ordering.\nCompaction-related parameters (file_to_compact, score, point) Compaction parameters are used to trigger compaction after a crash.\nComparator name Once the DB is initialized, the data sorting logic is fixed and cannot be changed. The comparator name serves as a credential.\nlog_number, next_file_number WAL number and the next available file number.\ndeleted_files and add_files SST files to be deleted or added due to compaction or reference count reaching zero.\nIn practice, each metadata change in LevelDB (usually caused by compaction) is recorded in a VersionEdit data structure. Thus, the DB state in LevelDB is essentially initial state + list of applied VersionEdits.\nVersion Control Since we mentioned VersionEdit, let’s also discuss the version control in LevelDB’s startup process, which mainly involves three data structures: Version, VersionEdit, and VersionSet.\nWhy is version control needed? In short, LevelDB uses the Multi-Version Concurrency Control (MVCC) mechanism to avoid using a big lock and improve performance.\nSnapshot reads at the command level are implemented via sequence_number. Each operation is assigned the current sequence_number, which is used to determine the data visible to that operation. Records with a sequence_number greater than that of the command are invisible to the operation.\nMVCC at the SST file level is implemented using a version chain, primarily to avoid conflicts in the following scenario: when reading a file while a background major compaction tries to delete that file.\nRelated Data Structures The main data structures related to SST-level MVCC are Version, VersionEdit, and VersionSet.\nVersion Represents the latest data state after startup or compaction.\nclass Version { VersionSet* vset_; // VersionSet to which this Version belongs Version* next_; // Next version in linked list Version* prev_; // Previous version in linked list int refs_; // Number of live refs to this version // List of files and metadata per level std::vector\u003cFileMetaData*\u003e files_[config::kNumLevels]; // Next file to compact based on seek stats (compaction due to allowed_seek exhaustion) FileMetaData* file_to_compact_; int file_to_compact_level_; // Level that should be compacted next and its compaction score. // Score \u003c 1 means compaction is not strictly needed. These fields // are initialized by Finalize(). double compaction_score_; // Score represents data imbalance; higher score indicates greater imbalance and compaction need. int compaction_level_; } VersionSet Manages the current runtime state of the entire DB.\nclass VersionSet { Env* const env_; const std::string dbname_; const Options* const options_; TableCache* const table_cache_; const InternalKeyComparator icmp_; uint64_t next_file_number_; uint64_t manifest_file_number_; uint64_t last_sequence_; uint64_t log_number_; uint64_t prev_log_number_; // 0 or backing store for memtable being compacted // Opened lazily WritableFile* descriptor_file_; // descriptor_ is for manifest file log::Writer* descriptor_log_; // descriptor_ is for manifest file Version dummy_versions_; // Head of circular doubly-linked list of versions. Version* current_; // == dummy_versions_.prev_ // Per-level key at which the next compaction at that level should start. // Either an empty string, or a valid InternalKey. std::string compact_pointer_[config::kNumLevels]; } VersionEdit Encapsulates metadata changes. This encapsulation reduces the window for version switching.\nclass VersionEdit { /** other code */ typedef std::set\u003cstd::pair\u003cint, uint64_t\u003e\u003e DeletedFileSet; std::string comparator_; uint64_t log_number_; uint64_t prev_log_number_; uint64_t next_file_number_; SequenceNumber last_sequence_; bool has_comparator_; bool has_log_number_; bool has_prev_log_number_; bool has_next_file_number_; bool has_last_sequence_; std::vector\u003cstd::pair\u003cint, InternalKey\u003e\u003e compact_pointers_; DeletedFileSet deleted_files_; std::vector\u003cstd::pair\u003cint, FileMetaData\u003e\u003e new_files_; }; Manifest Content As mentioned earlier, the manifest is LevelDB’s metadata file that stores the persistent state of the database. During startup, LevelDB may need to restore the previous DB state using existing data files. Additionally, when a version changes, LevelDB generates a VersionEdit. The metadata changes recorded by VersionEdit need to be persisted to the manifest to ensure LevelDB’s MVCC multi-version state is crash-safe. Thus, the encoding layout inside the manifest is crucial.\nInternally, metadata is encoded as SnapshotSessionRecord + list of SessionRecords, essentially initial state + list of applied VersionEdits.\nA manifest contains several session records. The first session record stores the full version information of LevelDB at that time, while subsequent session records only record incremental changes.\nA session record may contain the following fields:\nComparer name Latest WAL file number Next available file number The largest sequence number among the data persisted by the DB Information on new files Information on deleted files Compaction record information Writing Version Changes to the Manifest For LevelDB, adding or deleting some SSTable files needs to be an atomic operation to maintain database consistency before and after the state change.\nAtomicity Atomicity means that the operation is complete only when a session record is fully written to the manifest. If the process crashes before completion, the database can be restored to a correct state on restart, and those useless SSTable files will be deleted with compaction resumed.\nConsistency Consistency is ensured by marking state changes with version updates, which occur at the very end of the process. Thus, the database always transitions from one consistent state to another.\nRestoring DB from the Manifest As LevelDB runs, the number of session records in a manifest grows. Therefore, each time LevelDB restarts, a new manifest is created, and the first session record captures a snapshot of the current version state.\nOutdated manifests are deleted during the recovery process at the next startup.\nLevelDB uses this method to control the size of the manifest file. However, if the database is not restarted, the manifest will keep growing.\nDB State Recovery Process Check lock status and create data directory. Check lockfile to determine if another DB instance exists. Check if the CURRENT file exists. Restore metadata from the manifest. Recover last_seq_number and file_number from the WAL. Main Open Process Create default DB and VersionEdit instances. Acquire lock. Restore metadata from manifest and WAL. If the new DB instance does not have a memtable, create one along with a WAL file. Apply VersionEdit and persist it to the manifest. Attempt to delete obsolete files. Attempt to compact data. References LevelDB files LevelDB handbook LevelDB documentation LevelDB implementation analysis My notes on LevelDB ",
  "wordCount" : "1312",
  "inLanguage": "en",
  "datePublished": "2022-04-09T14:43:25+08:00",
  "dateModified": "2022-04-09T14:43:25+08:00",
  "author":{
    "@type": "Person",
    "name": "NoneBack"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://noneback.github.io/blog/leveldb-%E5%90%AF%E5%8A%A8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "NoneBack",
    "logo": {
      "@type": "ImageObject",
      "url": "https://noneback.github.io/favicon.ico"
    }
  }
}
</script>
    <link rel="icon" href="/images/avatar.jpeg" sizes="16x16">

<link rel="apple-touch-icon" href="/images/avatar.jpeg">

<link rel="manifest" href="/images/avatar.jpeg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"
    integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"
    integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx"
    crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js"
    integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"
    crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            
            
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true },
                { left: "\\begin{equation}", right: "\\end{equation}", display: true },
                { left: "\\begin{align}", right: "\\end{align}", display: true },
                { left: "\\begin{alignat}", right: "\\end{alignat}", display: true },
                { left: "\\begin{gather}", right: "\\end{gather}", display: true },
                { left: "\\begin{CD}", right: "\\end{CD}", display: true },
                { left: "\\[", right: "\\]", display: true }
            ],
            
            throwOnError: false,
            trust: (context) => ['\\htmlId', '\\href'].includes(context.command),
            macros: {
                "\\eqref": "\\href{###1}{(\\text{#1})}",
                "\\ref": "\\href{###1}{\\text{#1}}",
                "\\label": "\\htmlId{#1}{}"
            }
        });
    });
</script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css" />

    
    
    <link rel="stylesheet" href="/css/main.min.ec28f09e946fc0df77c187fcd0d0ebde58fca6de8efb8e1620f3d45c32d4da88.css" integrity="sha256-7CjwnpRvwN93wYf80NDr3lj8pt6O&#43;44WIPPUXDLU2og=" crossorigin="anonymous" media="screen" />

    
    <link rel="stylesheet" href="/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css" />

    
    <script src="/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js"></script>
    <script>hljs.highlightAll();</script>

    <script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script>
    </head>
<body>
      <main class="wrapper"><nav class="navigation">
    <section class="container">
        <a class="navigation-brand" href="/">
            HOME
        </a>
        <input type="checkbox" id="menu-toggle" />
        <label class="menu-button float-right" for="menu-toggle">
            <span></span><span></span><span></span>
        </label>
        
        <ul class="navigation-list" id="navigation-list">
            
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/blog">Blog</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/tags">Tags</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/archives">Archive</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="https://umami-blog-pi.vercel.app/share/q7qW5hQ16F8cTkBD/noneback.github.io">Dashboard</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/about/">About</a>
            </li>
            
            

            <li class="navigation-item menu-separator">
                <span>|</span>
            </li>

            
            
            <li class="navigation-item navigation-social">
                <a class="navigation-link" href="https://github.com/noneback"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
            </li>
            
            

            <li class="navigation-item navigation-dark">
                <button id="mode" type="button" aria-label="toggle user light or dark theme">
                    <span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
                    <span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
                </button>
            </li>

            
            
            
            
            
            
            
            <li class="navigation-item navigation-language">
                <a href="https://noneback.github.io/zh/">中</a>
            </li>
            
            
            
            
        </ul>
        
    </section>
</nav>
<div id="content">
<article class="blog-single">
  <header class="blog-title">
    <h1>LevelDB Startup</h1>
  </header>

  <p>
  <small>
    April 9, 2022&nbsp;· 1312 words&nbsp;· 7 min</small>

  <small>
      
      ·
      
      
      <a href="https://noneback.github.io/tags/lsm/">LSM</a>
      
      <a href="https://noneback.github.io/tags/leveldb/">LevelDB</a>
      
    </small>
  
<p>

  <div class="blog-toc">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisites">Prerequisites</a>
      <ul>
        <li><a href="#database-files">Database Files</a></li>
        <li><a href="#db-state">DB State</a></li>
        <li><a href="#version-control">Version Control</a></li>
      </ul>
    </li>
    <li><a href="#db-state-recovery-process">DB State Recovery Process</a></li>
    <li><a href="#main-open-process">Main Open Process</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
  </div>

  <section class="blog-content"><p>This is the first chapter of my notes on reading the LevelDB source code, focusing on the startup process of LevelDB. This article is not a step-by-step source code tutorial, but rather a learning note that records my questions and thoughts.</p>
<p>A code repository with annotations will be shared on GitHub later for those interested in studying it.</p>
<h2 id="prerequisites">Prerequisites</h2>
<h3 id="database-files">Database Files</h3>
<p>For now, I won&rsquo;t delve into the encoding and naming details of these files (as I haven&rsquo;t reached that part yet). I&rsquo;ll focus on the meaning and role of each file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── 000005.ldb
</span></span><span style="display:flex;"><span>├── 000008.ldb  // sst or ldb are both sst files
</span></span><span style="display:flex;"><span>├── 000009.log  // WAL
</span></span><span style="display:flex;"><span>├── CURRENT  // Records the name of the manifest file in use, also indicates the presence of the database
</span></span><span style="display:flex;"><span>├── LOCK  // Empty file, ensures only one DB instance operates on the database
</span></span><span style="display:flex;"><span>├── LOG  // Logs printed by LevelDB
</span></span><span style="display:flex;"><span>├── LOG.old 
</span></span><span style="display:flex;"><span>└── MANIFEST-000007   // descriptor_file, metadata file
</span></span></code></pre></div><p>Some questions worth exploring, which I may write about later:</p>
<ul>
<li>How does LOCK ensure only one DB instance holds the database?</li>
</ul>
<blockquote>
<p>Essentially, it uses the <code>fcntl</code> system call to set a write lock on the LOCK file.</p>
</blockquote>
<ul>
<li>Encoding issues of various files</li>
</ul>
<blockquote>
<p>I&rsquo;ll discuss LevelDB&rsquo;s encoding design in a future blog.</p>
</blockquote>
<h3 id="db-state">DB State</h3>
<p>LevelDB is an embedded database, often used as a component in other applications (e.g., for metadata nodes in distributed storage systems). These applications may crash or exit gracefully, leaving LevelDB data files behind. Thus, it&rsquo;s necessary to restore the previous database state during startup to ensure data integrity.</p>
<p>So, what should the DB state include? LevelDB is an LSM-based storage engine, essentially an <code>LSM Tree data structure + various read/write and storage optimizations</code>. Based on this and LevelDB&rsquo;s documentation, the DB state includes at least the following persistent information:</p>
<ul>
<li>The SST files for each level and the key range covered by each SST file
<blockquote>
<p>The key range helps avoid unnecessary I/O.</p>
</blockquote>
</li>
<li>Global logical clock, <code>last_seq_number</code>
<blockquote>
<p>Each data update has a <code>seq_num</code> that marks the recency of the update and is related to ordering.</p>
</blockquote>
</li>
<li>Compaction-related parameters (<code>file_to_compact</code>, <code>score</code>, <code>point</code>)
<blockquote>
<p>Compaction parameters are used to trigger compaction after a crash.</p>
</blockquote>
</li>
<li>Comparator name
<blockquote>
<p>Once the DB is initialized, the data sorting logic is fixed and cannot be changed. The comparator name serves as a credential.</p>
</blockquote>
</li>
<li><code>log_number</code>, <code>next_file_number</code>
<blockquote>
<p>WAL number and the next available file number.</p>
</blockquote>
</li>
<li><code>deleted_files</code> and <code>add_files</code>
<blockquote>
<p>SST files to be deleted or added due to compaction or reference count reaching zero.</p>
</blockquote>
</li>
</ul>
<p>In practice, each metadata change in LevelDB (usually caused by compaction) is recorded in a <code>VersionEdit</code> data structure. Thus, the DB state in LevelDB is essentially <code>initial state + list of applied VersionEdits</code>.</p>
<h3 id="version-control">Version Control</h3>
<p>Since we mentioned <code>VersionEdit</code>, let&rsquo;s also discuss the version control in LevelDB&rsquo;s startup process, which mainly involves three data structures: <code>Version</code>, <code>VersionEdit</code>, and <code>VersionSet</code>.</p>
<p>Why is version control needed? In short, LevelDB uses the Multi-Version Concurrency Control (MVCC) mechanism to avoid using a big lock and improve performance.</p>
<p>Snapshot reads at the command level are implemented via <code>sequence_number</code>. Each operation is assigned the current <code>sequence_number</code>, which is used to determine the data visible to that operation. Records with a <code>sequence_number</code> greater than that of the command are invisible to the operation.</p>
<p>MVCC at the SST file level is implemented using a version chain, primarily to avoid conflicts in the following scenario: when reading a file while a background major compaction tries to delete that file.</p>
<h4 id="related-data-structures">Related Data Structures</h4>
<p>The main data structures related to SST-level MVCC are <code>Version</code>, <code>VersionEdit</code>, and <code>VersionSet</code>.</p>
<h5 id="version">Version</h5>
<p>Represents the latest data state after startup or compaction.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Version</span> {  
</span></span><span style="display:flex;"><span>    VersionSet<span style="color:#f92672">*</span> vset_;  <span style="color:#75715e">// VersionSet to which this Version belongs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Version<span style="color:#f92672">*</span> next_;     <span style="color:#75715e">// Next version in linked list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      Version<span style="color:#f92672">*</span> prev_;     <span style="color:#75715e">// Previous version in linked list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">int</span> refs_;          <span style="color:#75715e">// Number of live refs to this version
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// List of files and metadata per level
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>FileMetaData<span style="color:#f92672">*&gt;</span> files_[config<span style="color:#f92672">::</span>kNumLevels];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Next file to compact based on seek stats (compaction due to allowed_seek exhaustion)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      FileMetaData<span style="color:#f92672">*</span> file_to_compact_;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> file_to_compact_level_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Level that should be compacted next and its compaction score.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// Score &lt; 1 means compaction is not strictly needed. These fields
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// are initialized by Finalize().
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">double</span> compaction_score_;  <span style="color:#75715e">// Score represents data imbalance; higher score indicates greater imbalance and compaction need.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">int</span> compaction_level_;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="versionset">VersionSet</h5>
<p>Manages the current runtime state of the entire DB.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VersionSet</span> {
</span></span><span style="display:flex;"><span>    Env<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> env_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string dbname_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> Options<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> options_;
</span></span><span style="display:flex;"><span>    TableCache<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> table_cache_;  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> InternalKeyComparator icmp_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> next_file_number_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> manifest_file_number_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> last_sequence_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> log_number_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> prev_log_number_;  <span style="color:#75715e">// 0 or backing store for memtable being compacted
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Opened lazily
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    WritableFile<span style="color:#f92672">*</span> descriptor_file_; <span style="color:#75715e">// descriptor_ is for manifest file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    log<span style="color:#f92672">::</span>Writer<span style="color:#f92672">*</span> descriptor_log_; <span style="color:#75715e">// descriptor_ is for manifest file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Version dummy_versions_;  <span style="color:#75715e">// Head of circular doubly-linked list of versions.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Version<span style="color:#f92672">*</span> current_;        <span style="color:#75715e">// == dummy_versions_.prev_
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Per-level key at which the next compaction at that level should start.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Either an empty string, or a valid InternalKey.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>string compact_pointer_[config<span style="color:#f92672">::</span>kNumLevels];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="versionedit">VersionEdit</h5>
<p>Encapsulates metadata changes. This encapsulation reduces the window for version switching.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VersionEdit</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/** other code */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">typedef</span> std<span style="color:#f92672">::</span>set<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&gt;&gt;</span> DeletedFileSet;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string comparator_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> log_number_;  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> prev_log_number_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> next_file_number_;
</span></span><span style="display:flex;"><span>    SequenceNumber last_sequence_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> has_comparator_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> has_log_number_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> has_prev_log_number_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> has_next_file_number_;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> has_last_sequence_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, InternalKey<span style="color:#f92672">&gt;&gt;</span> compact_pointers_;
</span></span><span style="display:flex;"><span>    DeletedFileSet deleted_files_;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, FileMetaData<span style="color:#f92672">&gt;&gt;</span> new_files_;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h4 id="manifest-content">Manifest Content</h4>
<p>As mentioned earlier, the manifest is LevelDB&rsquo;s metadata file that stores the persistent state of the database. During startup, LevelDB may need to restore the previous DB state using existing data files. Additionally, when a version changes, LevelDB generates a <code>VersionEdit</code>. The metadata changes recorded by <code>VersionEdit</code> need to be persisted to the manifest to ensure LevelDB&rsquo;s MVCC multi-version state is crash-safe. Thus, the encoding layout inside the manifest is crucial.</p>
<p>Internally, metadata is encoded as <code>SnapshotSessionRecord + list of SessionRecords</code>, essentially <code>initial state + list of applied VersionEdits</code>.</p>
<p><img alt="Manifest Structure" src="https://s2.loli.net/2022/04/11/AUusMjdYROz874v.jpg"></p>
<p>A manifest contains several session records. <strong>The first session record</strong> stores the <em>full version information</em> of LevelDB at that time, while subsequent session records only record incremental changes.</p>
<blockquote>
<p>A session record may contain the following fields:</p>
<ul>
<li>Comparer name</li>
<li>Latest WAL file number</li>
<li>Next available file number</li>
<li>The largest <code>sequence number</code> among the data persisted by the DB</li>
<li>Information on new files</li>
<li>Information on deleted files</li>
<li>Compaction record information</li>
</ul>
</blockquote>
<h5 id="writing-version-changes-to-the-manifest">Writing Version Changes to the Manifest</h5>
<p><img alt="Writing to Manifest" src="https://s2.loli.net/2022/04/14/7tlwEMPGgXHIp6s.jpg"></p>
<p>For LevelDB, adding or deleting some SSTable files needs to be an <strong>atomic operation</strong> to maintain <strong>database consistency</strong> before and after the state change.</p>
<h6 id="atomicity">Atomicity</h6>
<p><strong>Atomicity</strong> means that the operation is complete only when a session record is fully written to the manifest. If the process crashes before completion, the database can be restored to a correct state on restart, and those useless SSTable files will be deleted with compaction resumed.</p>
<h6 id="consistency">Consistency</h6>
<p><strong>Consistency</strong> is ensured by marking state changes with version updates, which occur at the very end of the process. Thus, the database always transitions from one consistent state to another.</p>
<h5 id="restoring-db-from-the-manifest">Restoring DB from the Manifest</h5>
<p><img alt="Restoring DB from Manifest" src="https://s2.loli.net/2022/04/14/Jk5eyRzUWowi4YH.jpg"></p>
<p>As LevelDB runs, the number of session records in a manifest grows. Therefore, each time LevelDB restarts, a new manifest is created, and the first session record captures a snapshot of the current version state.</p>
<p>Outdated manifests are deleted during the recovery process at the next startup.</p>
<blockquote>
<p>LevelDB uses this method to control the size of the manifest file. However, if the database is not restarted, the manifest will keep growing.</p>
</blockquote>
<h2 id="db-state-recovery-process">DB State Recovery Process</h2>
<ol>
<li>Check lock status and create data directory.</li>
<li>Check <code>lockfile</code> to determine if another DB instance exists.</li>
<li>Check if the <code>CURRENT</code> file exists.</li>
<li>Restore metadata from the manifest.</li>
<li>Recover <code>last_seq_number</code> and <code>file_number</code> from the WAL.</li>
</ol>
<h2 id="main-open-process">Main Open Process</h2>
<ol>
<li>Create default DB and <code>VersionEdit</code> instances.</li>
<li>Acquire lock.</li>
<li>Restore metadata from manifest and WAL.</li>
<li>If the new DB instance does not have a <code>memtable</code>, create one along with a WAL file.</li>
<li>Apply <code>VersionEdit</code> and persist it to the manifest.</li>
<li>Attempt to delete obsolete files.</li>
<li>Attempt to compact data.</li>
</ol>
<h2 id="references">References</h2>
<ul>
<li><a href="https://zhaox.github.io/leveldb/2015/12/23/leveldb-files">LevelDB files</a></li>
<li><a href="https://leveldb-handbook.readthedocs.io/zh/latest/">LevelDB handbook</a></li>
<li><a href="https://github.com/google/leveldb/blob/main/doc/impl.md">LevelDB documentation</a></li>
<li><a href="https://github.com/1Feng/decode-leveldb/blob/master/doc/leveldb%E5%AE%9E%E7%8E%B0%E8%A7%A3%E6%9E%90.pdf">LevelDB implementation analysis</a></li>
<li><a href="https://github.com/noneback/leveldb_annotated">My notes on LevelDB</a></li>
</ul>
</section>

  
  
  <div class="paginator">
    
    <a class="prev" href="https://noneback.github.io/blog/mit6.824-raftkv/">
      <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375C21.4339 3.93962 21.3581 3.30535 21.1917 2.76787M3.77086 21.1546C1.9934 20.7777 0.973585 18.7264 1.08749 16.688C1.2668 13.479 1.15721 9.43135 1.00513 6.21507C0.87809 3.52811 3.12891 1.16316 5.51029 1.25008C9.76594 1.40542 15.377 1.20229 18.7912 1.00542C20.0864 0.930734 20.8406 1.63385 21.1917 2.76787M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787C23.1097 4.18217 23.13 12.4191 22.9004 16.3608C20.8478 24.0194 12.3061 23.6662 6.5 22.0658M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608C21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966C5.98257 11.8297 5.98456 11.9753 6.05061 12.0063C7.05496 12.4779 8.92941 13.9264 9.94496 15M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentColor" stroke-linecap="round"/>
      </svg>
      <span>MIT6.824-RaftKV</span></a>
    
    
    <a class="next" href="https://noneback.github.io/blog/mit6.824-raft/"><span>MIT6.824-Raft</span>
      <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375C21.4339 3.93962 21.3581 3.30535 21.1917 2.76787M3.77086 21.1546C1.9934 20.7777 0.973585 18.7264 1.08749 16.688C1.2668 13.479 1.15721 9.43135 1.00513 6.21507C0.87809 3.52811 3.12891 1.16316 5.51029 1.25008C9.76594 1.40542 15.377 1.20229 18.7912 1.00542C20.0864 0.930734 20.8406 1.63385 21.1917 2.76787M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787C23.1097 4.18217 23.13 12.4191 22.9004 16.3608C20.8478 24.0194 12.3061 23.6662 6.5 22.0658M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608C21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966C16.0174 11.8297 16.0154 11.9753 15.9494 12.0063C14.945 12.4779 13.0706 13.9264 12.055 15M15.5556 11.9667C13.1345 12.0608 8 12 6 11" stroke="currentColor" stroke-linecap="round"/>
      </svg>
    </a>
    
  </div>
  

  


  
  
<div class="comments">
  <script>
      const getTheme = window.localStorage && window.localStorage.getItem("theme");
      let theme = getTheme === 'dark' ? 'dark' : 'light';
      let s = document.createElement('script');
      s.src = 'https://giscus.app/client.js';
      s.setAttribute('data-repo', 'noneback\/noneback.github.io');
      s.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkzMTAyNzgwNTc=');
      s.setAttribute('data-category', 'Announcements');
      s.setAttribute('data-category-id', 'DIC_kwDOEn53qc4Cj4-F');
      s.setAttribute('data-mapping', 'pathname');
      s.setAttribute('data-strict', '0');
      s.setAttribute('data-reactions-enabled', '1');
      s.setAttribute('data-emit-metadata', '0');
      s.setAttribute('data-input-position', 'top');
      s.setAttribute('data-theme', theme);
      s.setAttribute('data-lang', 'en');
      s.setAttribute('data-loading', 'lazy');
      s.setAttribute('crossorigin', 'anonymous');
      s.setAttribute('async', '');
      document.querySelector('div.comments').innerHTML = '';
      document.querySelector('div.comments').appendChild(s);
  </script>
</div>

</article>


        </div><footer class="footer">
  <p>&copy; 2025 <a href="https://noneback.github.io/">NoneBack</a>
    Powered by
    <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>
    <a href="https://github.com/guangzhengli/hugo-theme-ladder" rel="noopener" target="_blank">Ladder</a>
️  </p>
</footer>

<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211C22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257M21.7387 7.71865C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257C17.1684 -1.24629 7.83127 0.632493 4.27577 5.04257C2.88063 6.77451 -0.0433281 11.1668 1.38159 16.6571C2.27481 20.0988 5.17269 22.2936 8.19743 22.7725M20.7188 5.04257C22.0697 6.9404 24.0299 11.3848 22.3541 15.4153M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814C11.1703 6.98257 11.0247 6.98456 10.9937 7.05061C10.5221 8.05496 9.07362 9.92941 8 10.945M11.0333 7.44444C10.9392 9.86549 11 15 12 17" stroke="currentColor" stroke-linecap="round"/>
    </svg>
</a>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>

<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Copied';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });
        codeblock.parentNode.appendChild(copybutton);
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.6.0/mermaid.min.js" crossorigin="anonymous"></script>
<script>
    mermaid.init(undefined, '.language-mermaid');
</script></main>
    </body><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
      const images = Array.from(document.querySelectorAll(".blog-content img"));
      images.forEach(img => {
          mediumZoom(img, {
              margin: 10,  
              scrollOffset: 40,  
              container: null,  
              template: null,  
              background: 'rgba(0, 0, 0, 0.5)'
          });
      });
  </script>

  
  <script src="/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js" integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin="anonymous" defer></script></html>
