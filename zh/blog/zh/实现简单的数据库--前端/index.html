<!DOCTYPE html>
<html lang="zh"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实现简单的SQL数据库--前端</title>
    <meta charset="utf-8">
    <meta name="description" content="Ladder@一直想去完成pingcap的tanlent Plan里面的tinySql路径，但一直没有开始。最近论坛上发现了pingcap创始人的tanle">
    <meta name="author" content="NoneBack">
    <link rel="canonical" href="https://noneback.github.io/zh/blog/zh/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93--%E5%89%8D%E7%AB%AF/">
        <meta name="google-site-verification" content="xxx">

    <link rel="alternate" type="application/rss+xml" href="https://noneback.github.io//index.xml" title="NoneBack">

    
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-H0SRTJWPEK"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-H0SRTJWPEK');
        }
      </script>
    
  




<script async defer data-website-id="43dc9e5a-7ab8-482e-94df-100975b5d2c8" src="https://umami-blog-pi.vercel.app/noneback-blog"></script>

    <meta property="og:url" content="https://noneback.github.io/zh/blog/zh/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93--%E5%89%8D%E7%AB%AF/">
  <meta property="og:site_name" content="NoneBack">
  <meta property="og:title" content="实现简单的SQL数据库--前端">
  <meta property="og:description" content="一直想去完成pingcap的tanlent Plan里面的tinySql路径，但一直没有开始。最近论坛上发现了pingcap创始人的tanle">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2020-11-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-11-10T00:00:00+00:00">
    <meta property="article:tag" content="SQL">
    <meta property="article:tag" content="Parsing">
    <meta property="article:tag" content="DB">
    <meta property="article:tag" content="GO">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="实现简单的SQL数据库--前端">
  <meta name="twitter:description" content="一直想去完成pingcap的tanlent Plan里面的tinySql路径，但一直没有开始。最近论坛上发现了pingcap创始人的tanle">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://noneback.github.io/zh/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "实现简单的SQL数据库--前端",
      "item": "https://noneback.github.io/zh/blog/zh/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93--%E5%89%8D%E7%AB%AF/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "实现简单的SQL数据库--前端",
  "name": "实现简单的SQL数据库--前端",
  "description": "一直想去完成pingcap的tanlent Plan里面的tinySql路径，但一直没有开始。最近论坛上发现了pingcap创始人的tanle",
  "keywords": [
    "SQL", "parse", "DB", "GO"
  ],
  "articleBody": "一直想去完成pingcap的tanlent Plan里面的tinySql路径，但一直没有开始。最近论坛上发现了pingcap创始人的tanlent plan入坑贴，下面的学长提示了这个从零实现数据库博客入门比较合适，于是写下这个博客。\n前端 与编译器类似，一个数据库软件也分为前端和后端。前端部分主要是SQL语句的解析以及一个REPL。\n获取tokens type token struct { value string kind tokenKind loc location } 模拟cursor扫描语句，将sql语句解析为一个一个token，token中包括了单词的种类，位置，值。\n获取单个token时，每次扫描结束，如果成功，更新光标，并返回一个新token地址以及更新后的光标位置，ok=true。\n如果失败，则返回nil,传入的初始化的光标位置不变，ok=false。\n最终处理所有语句，得到token地址数组\n// 主要流程 func lex(source string) ([]*token, error) { tokens := []*token{} cur := cursor{} for cur.pointer \u003c uint(len(source)) { lexers := []lexer{lexKeyword, lexSymbol, lexString, lexNumeric, lexIdentifier} isMatched := false for _, l := range lexers { if token, newCursor, ok := l(source, cur); ok { cur = newCursor // Omit nil tokens for valid, but empty syntax like newlines if token != nil { tokens = append(tokens, token) } isMatched = true break } } if isMatched { // match the next one continue } hint := \"\" if len(tokens) \u003e 0 { hint = \" after \" + tokens[len(tokens)-1].value } return nil, fmt.Errorf(\"Unable to lex token%s, at %d:%d\", hint, cur.loc.row, cur.loc.col) } return tokens, nil } 获得Ast 第二步，从tokens中，解析出一个抽象语法树。\nAst有statement[]组成，目前的解析器只解析select，insert，create三种语句。\ntype Ast struct { Statement []*Statement } type Statement struct { SelectStatement *SelectStatement CreateStatement *CreateStatement InsertStatement *InsertStatement Kind AstKind } 解析的思路是按照不同的sql语句，分析出相应的语法成分，最后形成最后的语法树\nSELECT语句 语法成分：\nSELECT ${ expression[] }$ FROM $ tableName $\nexample：select id,age,name from students\n1.解析出keyword SELECT\n2.解析expression[]\n3.解析出keyword FROM\n4.解析identifier $tableName$\n其中重点在于对expressions的理解与解析\n// parse the token at cursor and return an expression containing literal val and its kind func parseExpression(tokens []*token, initialCursor uint, _ token) (*expression, uint, bool) { cursor := initialCursor kinds := []tokenKind{identifierKind, numericKind, stringKind} for _, kind := range kinds { t, newCursor, ok := parseToken(tokens, cursor, kind) if ok { return \u0026expression{ literal: t, kind: literalKind, }, newCursor, true } } return nil, initialCursor, false } expression 只包括了stringKind，numericKind，identifierKind的字符集合。parseexpression读入一个token，如果cursor超出了tokens的长度或者Kind不是这三种，则返回错误的结果，遇到分隔符delimiter则正常返回。\nCREATE语句 语法成分\nCREATE TABLE $tableName$ ( $columnDef$ )\nexample:CREATE TABLE students(id string, age int, name string)\n1.解析出keyword CREATE\n2.解析出keyword TABLE\n3.解析identifier $tableName$\n4.解析 symbol (\n5.解析$columndef$\n6.解析symbol )\n解析CREATE的语句关键是对$columnDef$的解析\n//column type columnDefinition struct { name token datatype token } 解析columnDefinitions\n1.循环解析token，直到cur超出tokens范围或者解析出现错误\n首先解析identifier $name$,keyword $datatype$ 解析分隔符 symbol , // parse col def // func parseColumnDefinitions(tokens []*token, initialCursor uint, delimiter token) (*[]*columnDefinition, uint, bool) { cursor := initialCursor cds := []*columnDefinition{} for { if cursor \u003e= uint(len(tokens)) { return nil, initialCursor, false } // Look for a delimiter current := tokens[cursor] if delimiter.equals(current) { break } // Look for a comma // col devided by comma if len(cds) \u003e 0 { if !expectToken(tokens, cursor, tokenFromSymbol(commaSymbol)) { helpMessage(tokens, cursor, \"Expected comma\") return nil, initialCursor, false } cursor++ } // Look for a column name id, newCursor, ok := parseToken(tokens, cursor, identifierKind) if !ok { helpMessage(tokens, cursor, \"Expected column name\") return nil, initialCursor, false } cursor = newCursor // Look for a column type //like col_name type ty, newCursor, ok := parseToken(tokens, cursor, keywordKind) if !ok { helpMessage(tokens, cursor, \"Expected column type\") return nil, initialCursor, false } cursor = newCursor cds = append(cds, \u0026columnDefinition{ name: *id, datatype: *ty, }) } return \u0026cds, cursor, true } INSERT语句 语法成分\nINSERT INTO VALUES ( $expression[]$ )\nexample: INSERT INTO VALUES(1,20,Kate)\n1.解析keyword INSERT\n2.解析keyword INTO\n3.解析keyword VALUES\n4.解析symbol (\n5.解析 $expression[]$\n6.解析symbol )\n主函数parse 主函数分号作为分隔符解析三种sql语句\nfunc Parse(source string) (*Ast, error) { tokens, err := lex(source) if err != nil { return nil, err } ast := Ast{} cursor := uint(0) for cursor \u003c uint(len(source)) { //parse each statement divide by ';' and add to ast stmt, newCursor, ok := parseStatement(tokens, cursor, tokenFromSymbol(semicolonSymbol)) if !ok { helpMessage(tokens, cursor, \"Expected statement\") return nil, errors.New(\"Failed to parse,exit\") } cursor = newCursor ast.Statement = append(ast.Statement, stmt) atLeastOneSemicolon := false for expectToken(tokens, cursor, tokenFromSymbol(semicolonSymbol)) { cursor++ atLeastOneSemicolon = true } if !atLeastOneSemicolon { helpMessage(tokens, cursor, \"Expected semi-colon delimiter between statements\") return nil, errors.New(\"Missing semi-colon between statements\") } } return \u0026ast, nil } 简易后端 本文重点在于解析sql语句以及前端的编写思路，这次仅仅使用一个map in memory 作为后端。\n// backend in memory type MemoryBackend struct { tables map[string]*table } // table type table struct { columns []string columnTypes []ColumnType rows [][]MemoryCell } //Result type Results struct { Columns []struct { Type ColumnType Name string } Rows [][]Cell } REPL 下面是一个简单的REPL设计思路\nfunc main() { mb := NewMemoryBackend() reader := bufio.NewReader(os.Stdin) fmt.Println(\"Welcome to \") for { fmt.Print(\"# \") text, err := reader.ReadString('\\n') text = strings.Replace(text, \"\\n\", \"\", -1) ast, err := Parse(text) if err != nil { panic(err) } for _, stmt := range ast.Statements { switch stmt.Kind { case CreateKind: case InsertKind: case SelectKind: } } } 其他剩余代码见github\n参考 Writing a SQL database from scratch in Go\nPostgreSQL documentation\ngosql\n",
  "wordCount" : "1697",
  "inLanguage": "zh",
  "datePublished": "2020-11-10T00:00:00Z",
  "dateModified": "2020-11-10T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "NoneBack"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://noneback.github.io/zh/blog/zh/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93--%E5%89%8D%E7%AB%AF/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "NoneBack",
    "logo": {
      "@type": "ImageObject",
      "url": "https://noneback.github.io/favicon.ico"
    }
  }
}
</script>
    <link rel="icon" href="/images/avatar.jpeg" sizes="16x16">

<link rel="apple-touch-icon" href="/images/avatar.jpeg">

<link rel="manifest" href="/images/avatar.jpeg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"
    integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"
    integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx"
    crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js"
    integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"
    crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            
            
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true },
                { left: "\\begin{equation}", right: "\\end{equation}", display: true },
                { left: "\\begin{align}", right: "\\end{align}", display: true },
                { left: "\\begin{alignat}", right: "\\end{alignat}", display: true },
                { left: "\\begin{gather}", right: "\\end{gather}", display: true },
                { left: "\\begin{CD}", right: "\\end{CD}", display: true },
                { left: "\\[", right: "\\]", display: true }
            ],
            
            throwOnError: false,
            trust: (context) => ['\\htmlId', '\\href'].includes(context.command),
            macros: {
                "\\eqref": "\\href{###1}{(\\text{#1})}",
                "\\ref": "\\href{###1}{\\text{#1}}",
                "\\label": "\\htmlId{#1}{}"
            }
        });
    });
</script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css" />

    
    
    <link rel="stylesheet" href="/css/main.min.ec28f09e946fc0df77c187fcd0d0ebde58fca6de8efb8e1620f3d45c32d4da88.css" integrity="sha256-7CjwnpRvwN93wYf80NDr3lj8pt6O&#43;44WIPPUXDLU2og=" crossorigin="anonymous" media="screen" />

    
    <link rel="stylesheet" href="/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css" />

    
    <script src="/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js"></script>
    <script>hljs.highlightAll();</script>

    <script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script>
    </head>
<body>
      <main class="wrapper"><nav class="navigation">
    <section class="container">
        <a class="navigation-brand" href="/zh">
            HOME
        </a>
        <input type="checkbox" id="menu-toggle" />
        <label class="menu-button float-right" for="menu-toggle">
            <span></span><span></span><span></span>
        </label>
        
        <ul class="navigation-list" id="navigation-list">
            
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/zh/blog">文章</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/zh/tags">分类</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/zh/archives">历史文章</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="https://umami-blog-pi.vercel.app/share/q7qW5hQ16F8cTkBD/noneback.github.io">网站统计</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/zh/about/">About</a>
            </li>
            
            

            <li class="navigation-item menu-separator">
                <span>|</span>
            </li>

            
            
            <li class="navigation-item navigation-social">
                <a class="navigation-link" href="https://github.com/noneback"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
            </li>
            
            

            <li class="navigation-item navigation-dark">
                <button id="mode" type="button" aria-label="toggle user light or dark theme">
                    <span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
                    <span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
                </button>
            </li>

            
            
            
            
            
            <li class="navigation-item navigation-language">
                <a href="https://noneback.github.io/">EN</a>
            </li>
            
            
            
            
            
            
        </ul>
        
    </section>
</nav>
<div id="content">
<article class="blog-single">
  <header class="blog-title">
    <h1>实现简单的SQL数据库--前端</h1>
  </header>

  <p>
  <small>
    2020年11月10日&nbsp;· 1697 字&nbsp;· 4 分钟</small>

  <small>
      
      ·
      
      
      <a href="https://noneback.github.io/zh/tags/sql/">SQL</a>
      
      <a href="https://noneback.github.io/zh/tags/parsing/">Parsing</a>
      
      <a href="https://noneback.github.io/zh/tags/db/">DB</a>
      
      <a href="https://noneback.github.io/zh/tags/go/">GO</a>
      
    </small>
  
<p>

  <div class="blog-toc">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前端">前端</a>
      <ul>
        <li><a href="#获取tokens">获取tokens</a></li>
        <li><a href="#获得ast">获得Ast</a></li>
        <li><a href="#主函数parse">主函数parse</a></li>
      </ul>
    </li>
    <li><a href="#简易后端">简易后端</a></li>
    <li><a href="#repl">REPL</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>

  <section class="blog-content"><p>一直想去完成pingcap的tanlent Plan里面的tinySql路径，但一直没有开始。最近论坛上发现了pingcap创始人的tanlent plan入坑贴，下面的学长提示了这个从零实现数据库博客入门比较合适，于是写下这个博客。</p>
<h2 id="前端">前端</h2>
<p>与编译器类似，一个数据库软件也分为前端和后端。前端部分主要是SQL语句的解析以及一个REPL。</p>
<h3 id="获取tokens">获取tokens</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">token</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kind</span>  <span style="color:#a6e22e">tokenKind</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">loc</span>   <span style="color:#a6e22e">location</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>模拟cursor扫描语句，将sql语句解析为一个一个token，token中包括了<strong>单词的种类，位置，值</strong>。</p>
<p>获取单个token时，每次扫描结束，如果成功，更新光标，并返回一个新token地址以及更新后的光标位置，ok=true。</p>
<p>如果失败，则返回nil,传入的初始化的光标位置不变，ok=false。</p>
<p>最终处理所有语句，得到token地址数组</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 主要流程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">lex</span>(<span style="color:#a6e22e">source</span> <span style="color:#66d9ef">string</span>) ([]<span style="color:#f92672">*</span><span style="color:#a6e22e">token</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">tokens</span> <span style="color:#f92672">:=</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">token</span>{}
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">cur</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cursor</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">cur</span>.<span style="color:#a6e22e">pointer</span> &lt; uint(len(<span style="color:#a6e22e">source</span>)) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lexers</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">lexer</span>{<span style="color:#a6e22e">lexKeyword</span>, <span style="color:#a6e22e">lexSymbol</span>, <span style="color:#a6e22e">lexString</span>, <span style="color:#a6e22e">lexNumeric</span>, <span style="color:#a6e22e">lexIdentifier</span>}
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">isMatched</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">lexers</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">newCursor</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>(<span style="color:#a6e22e">source</span>, <span style="color:#a6e22e">cur</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cur</span> = <span style="color:#a6e22e">newCursor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Omit nil tokens for valid, but empty syntax like newlines
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">token</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">tokens</span> = append(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">token</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">isMatched</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isMatched</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// match the next one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">hint</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">tokens</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">hint</span> = <span style="color:#e6db74">&#34; after &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">tokens</span>[len(<span style="color:#a6e22e">tokens</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">value</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Unable to lex token%s, at %d:%d&#34;</span>, <span style="color:#a6e22e">hint</span>, <span style="color:#a6e22e">cur</span>.<span style="color:#a6e22e">loc</span>.<span style="color:#a6e22e">row</span>, <span style="color:#a6e22e">cur</span>.<span style="color:#a6e22e">loc</span>.<span style="color:#a6e22e">col</span>)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tokens</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="获得ast">获得Ast</h3>
<p>第二步，从tokens中，解析出一个抽象语法树。</p>
<p>Ast有statement[]组成，目前的解析器只解析select，insert，create三种语句。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Ast</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">Statement</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Statement</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Statement</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">SelectStatement</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SelectStatement</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">CreateStatement</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CreateStatement</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">InsertStatement</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">InsertStatement</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">Kind</span>            <span style="color:#a6e22e">AstKind</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>解析的思路是按照不同的sql语句，分析出相应的语法成分，最后形成最后的语法树</p>
<h4 id="select语句">SELECT语句</h4>
<p>语法成分：</p>
<blockquote>
<p>SELECT  ${ expression[] }$  FROM $ tableName $</p>
<p>example：select id,age,name from students</p>
</blockquote>
<p>1.解析出keyword SELECT</p>
<p>2.解析expression[]</p>
<p>3.解析出keyword FROM</p>
<p>4.解析identifier  $tableName$</p>
<p>其中重点在于对expressions的理解与解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// parse the token at cursor and return an expression containing literal val and its kind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">parseExpression</span>(<span style="color:#a6e22e">tokens</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">initialCursor</span> <span style="color:#66d9ef">uint</span>, <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">token</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">expression</span>, <span style="color:#66d9ef">uint</span>, <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">cursor</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">initialCursor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">kinds</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">tokenKind</span>{<span style="color:#a6e22e">identifierKind</span>, <span style="color:#a6e22e">numericKind</span>, <span style="color:#a6e22e">stringKind</span>}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">kind</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">kinds</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">newCursor</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parseToken</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#a6e22e">kind</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">expression</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">literal</span>: <span style="color:#a6e22e">t</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kind</span>:    <span style="color:#a6e22e">literalKind</span>,
</span></span><span style="display:flex;"><span>   }, <span style="color:#a6e22e">newCursor</span>, <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">initialCursor</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>expression 只包括了stringKind，numericKind，identifierKind的字符集合。parseexpression读入一个token，如果cursor超出了tokens的长度或者Kind不是这三种，则返回错误的结果，遇到分隔符delimiter则正常返回。</p>
<h4 id="create语句">CREATE语句</h4>
<p>语法成分</p>
<blockquote>
<p>CREATE TABLE  $tableName$ ( $columnDef$ )</p>
<p>example:CREATE TABLE students(id string, age int, name string)</p>
</blockquote>
<p>1.解析出keyword CREATE</p>
<p>2.解析出keyword TABLE</p>
<p>3.解析identifier  $tableName$</p>
<p>4.解析 symbol <em>(</em></p>
<p>5.解析$columndef$</p>
<p>6.解析symbol <em>)</em></p>
<p>解析CREATE的语句关键是对$columnDef$的解析</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//column
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">columnDefinition</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">name</span>     <span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">datatype</span> <span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>解析columnDefinitions</p>
<p>1.循环解析token，直到cur超出tokens范围或者解析出现错误</p>
<blockquote>
<ul>
<li>首先解析identifier $name$,keyword $datatype$</li>
<li>解析分隔符 symbol <em><strong>,</strong></em></li>
</ul>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// parse col def
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">parseColumnDefinitions</span>(<span style="color:#a6e22e">tokens</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">initialCursor</span> <span style="color:#66d9ef">uint</span>, <span style="color:#a6e22e">delimiter</span> <span style="color:#a6e22e">token</span>) (<span style="color:#f92672">*</span>[]<span style="color:#f92672">*</span><span style="color:#a6e22e">columnDefinition</span>, <span style="color:#66d9ef">uint</span>, <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">cursor</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">initialCursor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">cds</span> <span style="color:#f92672">:=</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">columnDefinition</span>{}
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cursor</span> <span style="color:#f92672">&gt;=</span> uint(len(<span style="color:#a6e22e">tokens</span>)) {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">initialCursor</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Look for a delimiter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">current</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tokens</span>[<span style="color:#a6e22e">cursor</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">delimiter</span>.<span style="color:#a6e22e">equals</span>(<span style="color:#a6e22e">current</span>) {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Look for a comma
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// col devided by comma
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">cds</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">expectToken</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#a6e22e">tokenFromSymbol</span>(<span style="color:#a6e22e">commaSymbol</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">helpMessage</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#e6db74">&#34;Expected comma&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">initialCursor</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">cursor</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Look for a column name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">newCursor</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parseToken</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#a6e22e">identifierKind</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">helpMessage</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#e6db74">&#34;Expected column name&#34;</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">initialCursor</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cursor</span> = <span style="color:#a6e22e">newCursor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Look for a column type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//like col_name type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">ty</span>, <span style="color:#a6e22e">newCursor</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parseToken</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#a6e22e">keywordKind</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">helpMessage</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#e6db74">&#34;Expected column type&#34;</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">initialCursor</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cursor</span> = <span style="color:#a6e22e">newCursor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cds</span> = append(<span style="color:#a6e22e">cds</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">columnDefinition</span>{
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">name</span>:     <span style="color:#f92672">*</span><span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">datatype</span>: <span style="color:#f92672">*</span><span style="color:#a6e22e">ty</span>,
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cds</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="insert语句">INSERT语句</h4>
<p>语法成分</p>
<blockquote>
<p>INSERT INTO VALUES ( $expression[]$ )</p>
<p>example: INSERT INTO VALUES(1,20,Kate)</p>
</blockquote>
<p>1.解析keyword INSERT</p>
<p>2.解析keyword INTO</p>
<p>3.解析keyword VALUES</p>
<p>4.解析symbol <em>(</em></p>
<p>5.解析 $expression[]$</p>
<p>6.解析symbol <em>)</em></p>
<h3 id="主函数parse">主函数parse</h3>
<p>主函数分号作为分隔符解析三种sql语句</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">source</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Ast</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lex</span>(<span style="color:#a6e22e">source</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ast</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Ast</span>{}
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">cursor</span> <span style="color:#f92672">:=</span> uint(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">cursor</span> &lt; uint(len(<span style="color:#a6e22e">source</span>)) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//parse each statement divide by &#39;;&#39; and add to ast
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">stmt</span>, <span style="color:#a6e22e">newCursor</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parseStatement</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#a6e22e">tokenFromSymbol</span>(<span style="color:#a6e22e">semicolonSymbol</span>))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">helpMessage</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#e6db74">&#34;Expected statement&#34;</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Failed to parse,exit&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cursor</span> = <span style="color:#a6e22e">newCursor</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">Statement</span> = append(<span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">Statement</span>, <span style="color:#a6e22e">stmt</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">atLeastOneSemicolon</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">expectToken</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#a6e22e">tokenFromSymbol</span>(<span style="color:#a6e22e">semicolonSymbol</span>)) {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">cursor</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">atLeastOneSemicolon</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">atLeastOneSemicolon</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">helpMessage</span>(<span style="color:#a6e22e">tokens</span>, <span style="color:#a6e22e">cursor</span>, <span style="color:#e6db74">&#34;Expected semi-colon delimiter between statements&#34;</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Missing semi-colon between statements&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ast</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="简易后端">简易后端</h2>
<p>本文重点在于解析sql语句以及前端的编写思路，这次仅仅使用一个map in memory 作为后端。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// backend in memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MemoryBackend</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">tables</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">table</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">table</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">columns</span>     []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">columnTypes</span> []<span style="color:#a6e22e">ColumnType</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">rows</span>        [][]<span style="color:#a6e22e">MemoryCell</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Results</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">Columns</span> []<span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Type</span> <span style="color:#a6e22e">ColumnType</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">Rows</span> [][]<span style="color:#a6e22e">Cell</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="repl">REPL</h2>
<p>下面是一个简单的REPL设计思路</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">mb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewMemoryBackend</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdin</span>)
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Welcome to &#34;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;# &#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">text</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">ReadString</span>(<span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">text</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">text</span>, <span style="color:#e6db74">&#34;\n&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ast</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">text</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>   panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">stmt</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">Statements</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">stmt</span>.<span style="color:#a6e22e">Kind</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">CreateKind</span>:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">InsertKind</span>:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SelectKind</span>:
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其他剩余代码见<a href="https://github.com/noneback/gosql">github</a></p>
<h2 id="参考">参考</h2>
<p><a href="https://notes.eatonphil.com/database-basics.html">Writing a SQL database from scratch in Go</a></p>
<p><a href="https://www.postgresql.org/docs/current/sql-syntax-lexical.html">PostgreSQL documentation</a></p>
<p><a href="https://github.com/eatonphil/gosql">gosql</a></p>
</section>

  
  
  <div class="paginator">
    
    <a class="prev" href="https://noneback.github.io/zh/blog/zh/lc402-%E7%A7%BB%E9%99%A4k%E4%BD%8D%E6%95%B0%E5%AD%97/">
      <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375C21.4339 3.93962 21.3581 3.30535 21.1917 2.76787M3.77086 21.1546C1.9934 20.7777 0.973585 18.7264 1.08749 16.688C1.2668 13.479 1.15721 9.43135 1.00513 6.21507C0.87809 3.52811 3.12891 1.16316 5.51029 1.25008C9.76594 1.40542 15.377 1.20229 18.7912 1.00542C20.0864 0.930734 20.8406 1.63385 21.1917 2.76787M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787C23.1097 4.18217 23.13 12.4191 22.9004 16.3608C20.8478 24.0194 12.3061 23.6662 6.5 22.0658M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608C21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966C5.98257 11.8297 5.98456 11.9753 6.05061 12.0063C7.05496 12.4779 8.92941 13.9264 9.94496 15M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentColor" stroke-linecap="round"/>
      </svg>
      <span>LC402 移除K位数字</span></a>
    
    
    <a class="next" href="https://noneback.github.io/zh/blog/zh/%E5%9F%BA%E4%BA%8E%E6%9C%B4%E7%B4%A0%E8%B4%9D%E5%8F%B6%E6%96%AF%E7%9A%84%E4%B8%AD%E6%96%87%E5%9E%83%E5%9C%BE%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6%E5%88%86%E7%B1%BB/"><span>基于朴素贝叶斯的中文垃圾电子邮件分类</span>
      <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375C21.4339 3.93962 21.3581 3.30535 21.1917 2.76787M3.77086 21.1546C1.9934 20.7777 0.973585 18.7264 1.08749 16.688C1.2668 13.479 1.15721 9.43135 1.00513 6.21507C0.87809 3.52811 3.12891 1.16316 5.51029 1.25008C9.76594 1.40542 15.377 1.20229 18.7912 1.00542C20.0864 0.930734 20.8406 1.63385 21.1917 2.76787M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787C23.1097 4.18217 23.13 12.4191 22.9004 16.3608C20.8478 24.0194 12.3061 23.6662 6.5 22.0658M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608C21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966C16.0174 11.8297 16.0154 11.9753 15.9494 12.0063C14.945 12.4779 13.0706 13.9264 12.055 15M15.5556 11.9667C13.1345 12.0608 8 12 6 11" stroke="currentColor" stroke-linecap="round"/>
      </svg>
    </a>
    
  </div>
  

  


  
  
<div class="comments">
  <script>
      const getTheme = window.localStorage && window.localStorage.getItem("theme");
      let theme = getTheme === 'dark' ? 'dark' : 'light';
      let s = document.createElement('script');
      s.src = 'https://giscus.app/client.js';
      s.setAttribute('data-repo', 'noneback\/noneback.github.io');
      s.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkzMTAyNzgwNTc=');
      s.setAttribute('data-category', 'Announcements');
      s.setAttribute('data-category-id', 'DIC_kwDOEn53qc4Cj4-F');
      s.setAttribute('data-mapping', 'pathname');
      s.setAttribute('data-strict', '0');
      s.setAttribute('data-reactions-enabled', '1');
      s.setAttribute('data-emit-metadata', '0');
      s.setAttribute('data-input-position', 'top');
      s.setAttribute('data-theme', theme);
      s.setAttribute('data-lang', 'en');
      s.setAttribute('data-loading', 'lazy');
      s.setAttribute('crossorigin', 'anonymous');
      s.setAttribute('async', '');
      document.querySelector('div.comments').innerHTML = '';
      document.querySelector('div.comments').appendChild(s);
  </script>
</div>

</article>


        </div><footer class="footer">
  <p>&copy; 2025 <a href="https://noneback.github.io/">NoneBack</a>
    Powered by
    <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>
    <a href="https://github.com/guangzhengli/hugo-theme-ladder" rel="noopener" target="_blank">Ladder</a>
️  </p>
</footer>

<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211C22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257M21.7387 7.71865C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257C17.1684 -1.24629 7.83127 0.632493 4.27577 5.04257C2.88063 6.77451 -0.0433281 11.1668 1.38159 16.6571C2.27481 20.0988 5.17269 22.2936 8.19743 22.7725M20.7188 5.04257C22.0697 6.9404 24.0299 11.3848 22.3541 15.4153M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814C11.1703 6.98257 11.0247 6.98456 10.9937 7.05061C10.5221 8.05496 9.07362 9.92941 8 10.945M11.0333 7.44444C10.9392 9.86549 11 15 12 17" stroke="currentColor" stroke-linecap="round"/>
    </svg>
</a>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>

<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Copied';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });
        codeblock.parentNode.appendChild(copybutton);
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.6.0/mermaid.min.js" crossorigin="anonymous"></script>
<script>
    mermaid.init(undefined, '.language-mermaid');
</script></main>
    </body><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
      const images = Array.from(document.querySelectorAll(".blog-content img"));
      images.forEach(img => {
          mediumZoom(img, {
              margin: 10,  
              scrollOffset: 40,  
              container: null,  
              template: null,  
              background: 'rgba(0, 0, 0, 0.5)'
          });
      });
  </script>

  
  <script src="/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js" integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin="anonymous" defer></script></html>
